# SPDX-License-Identifier: MIT
---
- name: Remove cluster configuration
  include_tasks: "cluster-destroy-{{ HA_Cluster_pcs_provider }}.yml"
  when: not HA_Cluster_cluster_present

- name: Install and configure HA cluster
  block:
    - name: Check role variables
      include_tasks: check-role-variables.yml

    - name: Configure cluster nodes
      include_tasks: cluster-setup.yml

    - name: Check if qdevice is configured
      command:
        cmd: pcs quorum config
      register: HA_Cluster_internal_pcs_quorum_config
      run_once: yes
      check_mode: no
      changed_when: no

    - name: Enable or disable cluster services on boot
      include_tasks: cluster-enable-disable.yml
      when: HA_Cluster_start_on_boot != "nochange"

    - name: Pcs auth
      # Auth is run after corosync.conf has been distributed so that pcs
      # distributes pcs tokens in the cluster automatically.
      include_tasks: pcs-auth.yml

    - name: Start the cluster and reload corosync.conf
      include_tasks: cluster-start-and-reload.yml
  when: HA_Cluster_cluster_present
