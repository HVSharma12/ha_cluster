# SPDX-License-Identifier: MIT
---
- name: Remove cluster configuration
  include_tasks: "cluster-destroy-{{ HA_Cluster_pcs_provider }}.yml"
  when: not HA_Cluster_cluster_present

- name: Install and configure HA cluster
  block:
    - name: Check role variables
      include_tasks: check-role-variables.yml

    - name: Extract all node names
      set_fact:
        HA_Cluster_internal_all_node_names: "\
        {{ HA_Cluster_internal_all_node_names | default([]) }} + \
        [ {{ hostvars[item].HA_Cluster.node_name | default(item) }} ]"
      loop: "{{ ansible_play_hosts }}"
      run_once: yes

    - name: Set pcsd SSL certificates
      include_tasks: pcs-set-ssl-certs.yml
      when:
        - HA_Cluster_pcsd_SSL_cert.public
        - HA_Cluster_pcsd_SSL_cert.private

    - name: Configure cluster nodes
      include_tasks: cluster-setup.yml

#    TODO: implement qdevice detection once qdevice is supported by the role
#    - name: Fetch corosync quorum configuration
#      command:
#        cmd: pcs quorum config
#      register: HA_Cluster_internal_pcs_quorum_config
#      run_once: yes
#      check_mode: no
#      changed_when: no
#      # This reads corosync.conf from the nodes. The file is not sent to the
#      # nodes in check mode.
#      when: not ansible_check_mode
    - name: Check if qdevice is configured
      set_fact:
        HA_Cluster_internal_qdevice_in_use: no
      run_once: yes

    - name: Enable or disable cluster services on boot
      include_tasks: cluster-enable-disable.yml
      when: HA_Cluster_start_on_boot != "nochange"

    - name: Pcs auth
      # Auth is run after corosync.conf has been distributed so that pcs
      # distributes pcs tokens in the cluster automatically.
      include_tasks: pcs-auth.yml

    - name: Start the cluster and reload corosync.conf
      include_tasks: cluster-start-and-reload.yml
  when: HA_Cluster_cluster_present
