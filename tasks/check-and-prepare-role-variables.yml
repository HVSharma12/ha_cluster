- name: Check cluster configuration variables
  block:
    - name: Fail if passwords or authkeys are not specified
      fail:
        msg: "{{ item }} must be specified"
      when: lookup("vars", item, default="") | length < 1
      loop:
        - ha_cluster_hacluster_password
        - ha_cluster_corosync_key_src
        - ha_cluster_pacemaker_key_src
      run_once: yes

    - name: Fail if fence-virt is installed with no authkey specified
      fail:
        msg: "ha_cluster_fence_virt_key_src must be specified if fence-virt is installed"
      when:
        - ha_cluster_fence_virt_key_src | length < 1
        - "'fence-virt' in ha_cluster_fence_agent_packages"
      run_once: yes
  when: ha_cluster_cluster_present

- name: Extract all node names
  set_fact:
    __ha_cluster_node_name: "{{ \
        hostvars[item].ha_cluster.node_name | default(item) \
      }}"
  loop: "{{ ansible_play_hosts }}"
  run_once: yes
  register: __ha_cluster_node_name_result

- name: Collect all node names
  set_fact:
    __ha_cluster_all_node_names: "{{
        __ha_cluster_node_name_result.results \
        | map(attribute='ansible_facts.__ha_cluster_node_name') \
        | list \
      }}"
  run_once: yes
