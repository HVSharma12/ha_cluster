# SPDX-License-Identifier: MIT
---
# TODO: make creating SBD headers idempotent
# - name: Check SBD device headers
#   command: "sbd -d {{ item }}  dump"
#   run_once: true
#   ignore_errors: true
#   register: "sbd_dump_{{ item }}"
#   loop: "{{ ha_cluster_sbd_devices }}"
#   when:
#     - ha_cluster_sbd_devices

# TODO: deadlock if SBD was working before and cluster was stopped
- name: Create SBD devices
  command: sbd -d {{ item }} {{ ha_cluster_sbd_create_params }} create
  run_once: true
  loop: "{{ ha_cluster_sbd_devices }}"
  when:
    - ha_cluster_sbd_devices

- name: Enable softdog module
  copy:
    content: softdog
    dest: /etc/modules-load.d/softdog.conf
    owner: root
    group: root
    mode: '0644'
  notify: Load softdog module

- name: Create SBD configuration file
  template:
    src: templates/sbd.j2
    dest: /etc/sysconfig/sbd
    owner: root
    group: root
    mode: '0644'
  when: ha_cluster_sbd_devices

- name: Enable and start SBD
  service:
    name: sbd
    enabled: true
    state: started

# TODO: automatically create stonith fence resources
#       e.g. via pcs-cib-resource-create-pcs-0.10.yml?
